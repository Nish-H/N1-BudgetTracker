<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nishen's Budget Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoad()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoad()"></script>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div id="root" class="flex h-screen relative">
    <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-20 p-2 bg-indigo-600 text-white rounded">Menu</button>

    <div id="sidebar" class="w-64 bg-indigo-600 text-white p-6 space-y-6 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform z-10 overflow-y-auto hidden">
      <h1 class="text-2xl font-bold">Nishen's Budget</h1>
      <div id="yearDisplay" class="text-4xl font-bold">2025</div>
      <select id="yearSelect" class="bg-indigo-700 p-2 rounded w-full text-white"></select>
      <select id="monthSelect" class="bg-indigo-700 p-2 rounded w-full text-white"></select>
      <nav class="space-y-2" id="navButtons"></nav>
      <button id="saveBtn" onclick="saveToDrive()" class="bg-green-600 hover:bg-green-700 p-4 rounded w-full font-bold" disabled>Save to Drive</button>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-5 hidden md:hidden"></div>

    <div class="flex-1 ml-0 md:ml-64 p-4 md:p-8 overflow-y-auto" id="mainContent">
      <div id="tabContent" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="mt-4">Loading…</p>
      </div>
    </div>
  </div>

  <script>
    // YOUR REAL CLIENT ID
    const CLIENT_ID = "525866973256-sm8gpped3p1kvghkvahcovnppfr7bi1d.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let accessToken = null;
    let tokenClient;

    let userData = {
      year: new Date().getFullYear(),
      month: new Date().getMonth(),
      income: { salary: 0, fnb: 0, capitec: 0, other: 0 },
      expenses: { fixed: { rent: {budget:0,actual:0}, utilities: {budget:0,actual:0} }, variable: { groceries: {budget:0,actual:0}, transport: {budget:0,actual:0} } },
      savings: { target: 5000, actual: 0, categories: [] }
    };

    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    function loadLocal() { const s = localStorage.getItem('nishenBudget'); if(s) userData = {...userData, ...JSON.parse(s)}; }
    function saveLocal() { localStorage.setItem('nishenBudget', JSON.stringify(userData)); }
    loadLocal();

    function gapiLoad() {
      gapi.load('client', async () => {
        await gapi.client.init({});
        maybeStart();
      });
    }

    function gisLoad() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.access_token) {
            accessToken = resp.access_token;
            document.getElementById('saveBtn').disabled = false;
            updateStatus('Connected – ready to save');
            loadDataFromDrive();
          }
        },
      });
      maybeStart();
    }

    function maybeStart() { if (gapi.client && tokenClient) render(); }

    // FULLY WORKING SAVE TO DRIVE (multipart upload)
    async function saveToDrive() {
      if (!accessToken) return alert('Connect to Drive first');
      const boundary = '-------314159265358979323846';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      const metadata = { name: 'NishenBudgetData.json', mimeType: 'application/json' };
      const content = JSON.stringify(userData, null, 2);

      const body = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter +
                   'Content-Type: application/json\r\n\r\n' + content + close_delim;

      try {
        const list = await gapi.client.drive.files.list({ q: "name='NishenBudgetData.json'" });
        let url, method;
        if (list.result.files?.length > 0) {
          url = `https://www.googleapis.com/upload/drive/v3/files/${list.result.files[0].id}?uploadType=multipart`;
          method = 'PATCH';
        } else {
          url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
          method = 'POST';
        }

        const response = await fetch(url, {
          method,
          headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'multipart/related; boundary=' + boundary },
          body
        });

        if (response.ok) {
          updateStatus('Saved to Google Drive');
          saveLocal();
        } else {
          const err = await response.text();
          updateStatus('Save failed: ' + response.status);
          console.error(err);
        }
      } catch(e) {
        updateStatus('Error – check console');
        console.error(e);
      }
    }

    async function loadDataFromDrive() {
      if (!accessToken) return;
      try {
        const r = await gapi.client.drive.files.list({ q: "name='NishenBudgetData.json' and trashed=false", fields: 'files(id)' });
        if (r.result.files?.length > 0) {
          const f = await gapi.client.drive.files.get({ fileId: r.result.files[0].id, alt: 'media' });
          userData = { ...userData, ...JSON.parse(f.body) };
          saveLocal();
          updateStatus('Loaded from Drive');
        }
      } catch(e) { console.log('No file yet'); }
      render();
    }

    function updateStatus(msg) {
      let el = document.getElementById('status');
      if (!el) {
        el = document.createElement('p'); el.id = 'status'; el.className = 'text-sm text-gray-600 mt-4';
        document.getElementById('tabContent').appendChild(el);
      }
      el.textContent = 'Drive Status: ' + msg;
    }

    function render() {
      document.getElementById('yearDisplay').textContent = userData.year;
      document.getElementById('yearSelect').innerHTML = [2023,2024,2025,2026,2027].map(y=>`<option ${y===userData.year?'selected':''}>${y}</option>`).join('');
      document.getElementById('monthSelect').innerHTML = months.map((m,i)=>`<option ${i===userData.month?'selected':''}>${m}</option>`).join('');
      document.getElementById('yearSelect').onchange = e => { userData.year = +e.target.value; saveLocal(); render(); };
      document.getElementById('monthSelect').onchange = e => { userData.month = +e.target.value; saveLocal(); render(); };

      document.getElementById('navButtons').innerHTML = 
        ['Dashboard','Income','Expenses','Savings','Reports','Settings'].map(t=>
          `<button onclick="showTab('${t.toLowerCase()}')" class="block w-full text-left p-3 rounded hover:bg-indigo-700">${t}</button>`
        ).join('');

      document.getElementById('sidebar').classList.remove('hidden');

      document.getElementById('mobileMenuBtn').onclick = () => {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
        document.getElementById('overlay').classList.toggle('hidden');
      };
      document.getElementById('overlay').onclick = () => {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('overlay').classList.add('hidden');
      };

      showTab('dashboard');
    }

    window.showTab = function(tab) {
      const tabs = { dashboard, income, expenses, savings, reports, settings };
      document.getElementById('tabContent').innerHTML = tabs[tab]();
      if (tab === 'reports') setTimeout(drawCharts, 200);
    };

    function dashboard() {
      const inc = Object.values(userData.income).reduce((a,b)=>a+b,0);
      const expF = Object.values(userData.expenses.fixed).reduce((s,c)=>s+(c.actual||0),0);
      const expV = Object.values(userData.expenses.variable).reduce((s,c)=>s+(c.actual||0),0);
      const exp = expF + expV;
      const sav = userData.savings.actual||0;
      const left = inc - exp - sav;
      return `<h2 class="text-3xl font-bold mb-6">${months[userData.month]} ${userData.year}</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div class="bg-green-100 p-6 rounded-lg text-center"><div class="text-3xl font-bold text-green-700">R ${inc.toFixed(2)}</div><div>Income</div></div>
          <div class="bg-red-100 p-6 rounded-lg text-center"><div class="text-3xl font-bold text-red-700">R ${exp.toFixed(2)}</div><div>Expenses</div></div>
          <div class="bg-blue-100 p-6 rounded-lg text-center"><div class="text-3xl font-bold text-blue-700">R ${sav.toFixed(2)}</div><div>Savings</div></div>
          <div class="bg-${left>=0?'green':'red'}-100 p-6 rounded-lg text-center"><div class="text-3xl font-bold ${left>=0?'text-green-700':'text-red-700'}">R ${left.toFixed(2)}</div><div>Left</div></div>
        </div>`;
    }

    function income() {
      let html = `<h2 class="text-3xl font-bold mb-6">Income Sources</h2><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow max-w-2xl space-y-4">`;
      Object.entries(userData.income).forEach(([k,v]) => {
        html += `<div class="flex items-center space-x-4">
          <label class="w-32 font-semibold capitalize">${k === 'fnb' ? 'FNB' : k === 'capitec' ? 'Capitec' : k}</label>
          <input type="number" step="0.01" value="${v}" onchange="userData.income['${k}']=+this.value||0; saveLocal(); showTab('income')" 
                 class="flex-1 border rounded px-3 py-2 text-black bg-white">
        </div>`;
      });
      html += `<div class="pt-4 border-t text-xl font-bold">Total: R ${Object.values(userData.income).reduce((a,b)=>a+b,0).toFixed(2)}</div></div>`;
      return html;
    }

    function expenses() {
      let html = `<h2 class="text-3xl font-bold mb-6">Expenses</h2><div class="grid md:grid-cols-2 gap-8">`;
      ['fixed','variable'].forEach(type => {
        const total = Object.values(userData.expenses[type]).reduce((s,c)=>s+(c.actual||0),0);
        html += `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <h3 class="text-2xl font-bold mb-4 capitalize">${type} Expenses (R ${total.toFixed(2)})</h3>`;
        Object.entries(userData.expenses[type]).forEach(([k,c]) => {
          const diff = (c.budget||0) - (c.actual||0);
          html += `<div class="mb-4 p-4 border rounded">
            <label class="block font-semibold capitalize">${k}</label>
            <div class="grid grid-cols-3 gap-2 mt-2">
              <input type="number" placeholder="Budget" value="${c.budget||0}" onchange="userData.expenses.${type}['${k}'].budget=+this.value||0; saveLocal(); showTab('expenses')"
                     class="border rounded px-2 py-1 text-black bg-white">
              <input type="number" placeholder="Actual" value="${c.actual||0}" onchange="userData.expenses.${type}['${k}'].actual=+this.value||0; saveLocal(); showTab('expenses')"
                     class="border rounded px-2 py-1 text-black bg-white">
              <div class="text-sm text-right">Diff: R ${diff.toFixed(2)}</div>
            </div>
          </div>`;
        });
        html += `<button onclick="addCat('${type}')" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">+ Add ${type} category</button></div>`;
      });
      html += `</div>`;
      return html;
    }

    window.addCat = function(type) {
      const name = prompt(`New ${type} category name:`);
      if (name) userData.expenses[type][name.toLowerCase().replace(/ /g,'_')] = {budget:0,actual:0};
      saveLocal(); showTab('expenses');
    };

    function savings() {
      const prog = userData.savings.target ? (userData.savings.actual / userData.savings.target)*100 : 0;
      return `<h2 class="text-3xl font-bold mb-6">Savings Goal</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow max-w-lg">
          <input type="number" value="${userData.savings.target}" onchange="userData.savings.target=+this.value||0; saveLocal(); showTab('savings')"
                 class="w-full border rounded px-3 py-2 text-black bg-white mb-3" placeholder="Target">
          <input type="number" value="${userData.savings.actual}" onchange="userData.savings.actual=+this.value||0; saveLocal(); showTab('savings')"
                 class="w-full border rounded px-3 py-2 text-black bg-white mb-3" placeholder="Actual">
          <div class="w-full bg-gray-300 rounded-full h-8"><div class="bg-blue-600 h-8 rounded-full text-white text-center leading-8" style="width:${Math.min(prog,100)}%">${prog.toFixed(0)}%</div></div>
        </div>`;
    }

    function reports() {
      return `<h2 class="text-3xl font-bold mb-6">Reports</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><canvas id="chart1"></canvas></div>
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><canvas id="chart2"></canvas></div>
        </div>`;
    }

    function settings() {
      return `<h2 class="text-3xl font-bold mb-6">Settings</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow max-w-md">
          <button onclick="tokenClient.requestAccessToken()" class="bg-blue-600 text-white px-6 py-3 rounded mb-4">Connect Google Drive</button>
          <div id="status" class="text-sm text-gray-600">Drive Status: Not connected</div>
          <label class="flex items-center mt-4"><input type="checkbox" onchange="document.documentElement.classList.toggle('dark',this.checked)" class="mr-2"> Dark Mode</label>
        </div>`;
    }

    function drawCharts() {
      // Income bar chart
      new Chart(document.getElementById('chart1'), {
        type: 'bar', data: { labels: Object.keys(userData.income), datasets: [{ label: 'Income', data: Object.values(userData.income), backgroundColor: '#10b981' }] }
      });
      // Expense pie
      const expLabels = [...Object.keys(userData.expenses.fixed), ...Object.keys(userData.expenses.variable)];
      const expData = expLabels.map(k => userData.expenses.fixed[k]?.actual || userData.expenses.variable[k]?.actual || 0);
      new Chart(document.getElementById('chart2'), {
        type: 'pie', data: { labels: expLabels, datasets: [{ data: expData, backgroundColor: ['#ef4444','#f59e0b','#10b981','#3b82f6'] }] }
      });
    }

    window.saveToDrive = saveToDrive;
    render();
  </script>
</body>
</html>
